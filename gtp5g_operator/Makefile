# Makefile for GTP5G Operator

GO := go
CLANG := clang
ARCH := $(shell uname -m | sed 's/x86_64/x86/')
BPF_DIR := bpf
CMD_DIR := cmd
OUTPUT_DIR := bin

# BPF compilation flags
CFLAGS := -g -O2 -target bpf -D__TARGET_ARCH_$(ARCH)
INCLUDES := -I$(BPF_DIR) -I../libbpfgo/output

.PHONY: help build bpf go test clean fmt deps

help: ## é¡¯ç¤ºå¹«åŠ©è¨Šæ¯
	@echo "ä½¿ç”¨æ–¹æ³•: make [target]"
	@echo ""
	@echo "ç›®æ¨™:"
	@echo "  build    ğŸ”¨ ç·¨è­¯ eBPF å’Œ Go ç¨‹å¼"
	@echo "  bpf      ğŸ”¨ åªç·¨è­¯ eBPF ç¨‹å¼"
	@echo "  go       ğŸ”¨ åªç·¨è­¯ Go ç¨‹å¼"
	@echo "  test     ğŸ§ª åŸ·è¡Œæ¸¬è©¦"
	@echo "  clean    ğŸ§¹ æ¸…ç†ç·¨è­¯æª”æ¡ˆ"
	@echo "  fmt      ğŸ¨ æ ¼å¼åŒ–ç¨‹å¼ç¢¼"
	@echo "  deps     ğŸ“¦ å®‰è£ä¾è³´"
	@echo "  help     â“ é¡¯ç¤ºæ­¤å¹«åŠ©è¨Šæ¯"

build: bpf go ## ç·¨è­¯ eBPF + Go ç¨‹å¼
	@echo "âœ… å»ºç½®å®Œæˆ"

bpf: ## åªç·¨è­¯ eBPF ç¨‹å¼
	@echo "ğŸ”¨ ç·¨è­¯ eBPF ç¨‹å¼..."
	@mkdir -p $(BPF_DIR)/output
	@if [ -f $(BPF_DIR)/gtp5g_operator.bpf.c ]; then \
		$(CLANG) $(CFLAGS) $(INCLUDES) -c $(BPF_DIR)/gtp5g_operator.bpf.c -o $(BPF_DIR)/output/gtp5g_operator.bpf.o; \
		echo "âœ… eBPF ç·¨è­¯å®Œæˆ: $(BPF_DIR)/output/gtp5g_operator.bpf.o"; \
	else \
		echo "âš ï¸  æ‰¾ä¸åˆ° $(BPF_DIR)/gtp5g_operator.bpf.cï¼Œè·³éç·¨è­¯"; \
	fi

go: ## åªç·¨è­¯ Go ç¨‹å¼
	@echo "ğŸ”¨ ç·¨è­¯ Go ç¨‹å¼..."
	@mkdir -p $(OUTPUT_DIR)
	@if [ -f $(CMD_DIR)/main.go ]; then \
		$(GO) build -o $(OUTPUT_DIR)/gtp5g_operator $(CMD_DIR)/main.go; \
		echo "âœ… Go ç·¨è­¯å®Œæˆ: $(OUTPUT_DIR)/gtp5g_operator"; \
	else \
		echo "âš ï¸  æ‰¾ä¸åˆ° $(CMD_DIR)/main.goï¼Œè·³éç·¨è­¯"; \
	fi

test: ## åŸ·è¡Œæ¸¬è©¦
	@echo "ğŸ§ª åŸ·è¡Œæ¸¬è©¦..."
	$(GO) test -v ./...

clean: ## æ¸…ç†ç·¨è­¯æª”æ¡ˆ
	@echo "ğŸ§¹ æ¸…ç†ä¸­..."
	@rm -rf $(OUTPUT_DIR)
	@rm -rf $(BPF_DIR)/output
	@echo "âœ… æ¸…ç†å®Œæˆ"

fmt: ## æ ¼å¼åŒ–ç¨‹å¼ç¢¼
	@echo "ğŸ¨ æ ¼å¼åŒ– Go ç¨‹å¼ç¢¼..."
	$(GO) fmt ./...

deps: ## å®‰è£ä¾è³´
	@echo "ğŸ“¦ å®‰è£ä¾è³´..."
	$(GO) mod tidy
